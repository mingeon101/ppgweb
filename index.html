<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì›¹ ì‹¬ë°•ìˆ˜ ì¸¡ì •</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    video { width: 300px; height: 200px; border-radius: 12px; }
    #bpm { font-size: 24px; margin-top: 20px; font-weight: bold; }
  </style>
</head>
<body>
  <h2>ğŸ“¸ ì¹´ë©”ë¼ ê¸°ë°˜ ì‹¬ë°•ìˆ˜ ì¸¡ì •</h2>
  <p>ìŠ¤ë§ˆíŠ¸í° ì¹´ë©”ë¼ì— ì†ê°€ë½ì„ ì˜¬ë ¤ë‘ì„¸ìš”</p>
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" width="300" height="200" style="display:none;"></canvas>
  <p id="bpm">ì‹¬ë°•ìˆ˜: ---</p>

  <script>
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const bpmText = document.getElementById("bpm");

    let values = [];
    let lastTime = Date.now();

    // ì¹´ë©”ë¼ ì‹¤í–‰
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      .then(stream => video.srcObject = stream)
      .catch(err => alert("ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨: " + err));

    function analyzeFrame() {
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      let frame = ctx.getImageData(0, 0, canvas.width, canvas.height).data;

      // ë°ê¸° í‰ê·  ê³„ì‚°
      let sum = 0;
      for (let i = 0; i < frame.length; i += 4) {
        sum += (frame[i] + frame[i+1] + frame[i+2]) / 3;
      }
      let brightness = sum / (frame.length / 4);

      // ìµœê·¼ ë°ì´í„° ì €ì¥
      values.push({ t: Date.now(), v: brightness });
      if (values.length > 300) values.shift(); // ìµœê·¼ 10ì´ˆ ì •ë„ë§Œ ë³´ê´€

      // ì‹¬ë°•ìˆ˜ ê³„ì‚°
      if (values.length > 50) {
        let peaks = 0;
        for (let i = 1; i < values.length - 1; i++) {
          if (values[i].v > values[i-1].v && values[i].v > values[i+1].v) {
            peaks++;
          }
        }
        // ë¶„ë‹¹ ì‹¬ë°•ìˆ˜ í™˜ì‚° (ìµœê·¼ 10ì´ˆ â†’ 1ë¶„ í™˜ì‚°)
        let bpm = Math.round(peaks * (60000 / (values[values.length-1].t - values[0].t)));
        if (bpm > 40 && bpm < 200) {
          bpmText.innerText = "ì‹¬ë°•ìˆ˜: " + bpm + " BPM";
        }
      }

      requestAnimationFrame(analyzeFrame);
    }

    analyzeFrame();
  </script>
</body>
</html>
